<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devices Overview - Supervisor</title>
    <link rel="stylesheet" href="css/style.css">
    
</head>
<body class="dashboard-body">
    <header class="topbar">
        <div class="topbar-logo-title" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
            <img src="assets/logoadlex.png" alt="ADLEX Logo" class="topbar-logo">
            <h2 class="topbar-title" style="margin:0;flex:1;text-align:center;">Devices Overview</h2>
            <span class="user-role-container">
        <span class="user-icon">👤</span>
        <span class="userRoleDisplay" id="userRoleDisplay"></span>
      </span>
        </div>
        <!-- <button id="darkModeToggle" style="margin-left:20px;">🌙</button> -->
    </header>
    <!-- Sidebar for normal users/admins -->
    <aside class="sidebar" id="sidebar-normal" style="display:none;">
        <button class="sidebar-arrow" id="sidebarToggle" aria-label="Toggle sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#007bff" stroke-width="2" viewBox="0 0 24 24">
              <rect x="3" y="4" width="7" height="16" rx="1" />
              <rect x="14" y="4" width="7" height="16" rx="1" />
            </svg>
          </button>
        <ul>    
        <li class="nav-link" onclick="navigate('users.html')"><span>📍</span><span>Location</span></li>
        <li class="nav-link active" onclick="navigate('supervisors.html')"><span>🧑‍💼</span><span>User</span></li>
        <li class="nav-link" onclick="navigate('devices.html')"><span>💻</span><span>Devices</span></li>  
        <li class="nav-link" onclick="navigate('logs.html')"><span>📜</span><span>Logs</span></li>
        <li class="nav-link" onclick="navigate('support.html')"><span>🆘</span><span>Support Center</span></li>
        </ul>
        <div class="logout-link" onclick="logout()"><span>🚪</span><span>Logout</span></div>
        <!-- <button class="sidebar-arrow" id="sidebarArrowNormal" aria-label="Hide menu">&#8592;</button> -->
    </aside>
    
    <!-- Sidebar for supervisors (read-only) -->
    <aside class="sidebar" id="sidebar-supervisor" style="display:none;">
        <button class="sidebar-arrow" id="sidebarToggle" aria-label="Toggle sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#007bff" stroke-width="2" viewBox="0 0 24 24">
              <rect x="3" y="4" width="7" height="16" rx="1" />
              <rect x="14" y="4" width="7" height="16" rx="1" />
            </svg>
          </button>
        <ul>
        <li class="nav-link active" onclick="navi('super_device_overview.html')"><span>📍</span><span>My Locations</span></li>
        <li class="nav-link" onclick="navigate('logs.html')"><span>📜</span><span>Logs</span></li>
        <li class="nav-link" onclick="navigate('support.html')"><span>🆘</span><span>Support Center</span></li>
        </ul>
        <div class="logout-link" onclick="logout()"><span>🚪</span><span>Logout</span></div>
        <!-- <button class="sidebar-arrow" id="sidebarArrowSupervisor" aria-label="Hide menu">&#8592;</button> -->
    </aside>
    <!-- Sidebar for superadmin -->
<aside class="sidebar" id="sidebar-superadmin" style="display:none;">
    <button class="sidebar-arrow" id="sidebarToggle" aria-label="Toggle sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#007bff" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="4" width="7" height="16" rx="1" />
          <rect x="14" y="4" width="7" height="16" rx="1" />
        </svg>
      </button>
    <ul>
      <li class="nav-link " onclick="navigate('superadmin-dashboard.html')"><span>📊</span><span>Dashboard</span></li>
      <li class="nav-link" onclick="navigate('users.html')"><span>📍</span><span>Location Management</span></li>
      <li class="nav-link active" onclick="navigate('supervisors.html')"><span>🧑‍💼</span><span>User Management</span></li>
      <li class="nav-link" onclick="navigate('devices.html')"><span>💻</span><span>Device Management</span></li>
      <li class="nav-link" onclick="navigate('logs.html')"><span>📜</span><span>System Logs</span></li>
      <li class="nav-link" onclick="navigate('support.html')"><span>🆘</span><span>Support Center</span></li>
    </ul>
    <div class="logout-link" onclick="logout()"><span>🚪</span><span>Logout</span></div>
    <!-- <button class="sidebar-arrow" id="sidebarArrowSuperadmin" aria-label="Hide menu">&#8592;</button> -->
  </aside>
    <!-- Common toggle buttons -->
    <!-- <button class="sidebar-arrow" id="sidebarArrowCommon" aria-label="Hide menu">&#8592;</button> -->
    <!-- <button class="sidebar-hamburger" id="sidebarHamburger" aria-label="Show menu">&#9776;</button> -->
    <main class="main-content">
        <div class="top-actions-bar" style="display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-bottom:20px;">
            <div class="search-panel">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search" oninput="filterUsers()" maxlength="30"/>
                    <span class="search-icon">🔍</span>
                </div>
            </div>
        </div>
        <div class="table-container">
            <button id="delete-all-btn">Delete All</button>
            <table class="user-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-super-device" /></th>
                        <th>Assigned User</th>
                        <th>Assigned Device</th>
                        <th class="action-col">Action</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
        <div class="footer-text">
            Powered by Samsan | © 2025 Revision
          </div>
    </main>
    <script>
        // Global variables
        const urlParams = new URLSearchParams(window.location.search);
        const supervisor_id = urlParams.get('supervisor_id');
        let allUserDevices = [];
        function applySupervisorRestrictions() {
            if (localStorage.getItem('userRole') === 'supervisor') {
                document.querySelectorAll('.super-device-row-checkbox').forEach(cb => {
                    cb.disabled = true;
                    cb.style.display = 'none';
                });
        
                document.querySelectorAll('.delete-super-device-btn, .confirm-delete-btn, .cancel-delete-btn').forEach(btn => {
                    btn.style.display = 'none';
                    btn.disabled = true;
                });
        
                const deleteAllBtn = document.getElementById('delete-all-btn');
                if (deleteAllBtn) deleteAllBtn.style.display = 'none';
            }
        }
        

        // Load user devices data
        async function loadUserDevices() {
            if (!supervisor_id) return;
            try {
                const res = await fetch(`/api/supervisor-users-devices/${supervisor_id}`);
                const userDevices = await res.json();
                allUserDevices = userDevices;
                renderUserDevices(userDevices);
            } catch (error) {
                console.error('Error loading user devices:', error);
                document.getElementById('user-table-body').innerHTML = '<tr><td colspan="4">Error loading data</td></tr>';
            }
        }

        // Render user devices in table
        function renderUserDevices(userDevices) {
            const table = document.getElementById('user-table-body');
            table.innerHTML = '';
            
            userDevices.forEach(ud => {
                const user = ud.user;
                const devices = ud.devices;
                const row = document.createElement('tr');
                
                row.onclick = () => goToUserDevices(user.address);
                row.innerHTML = `
                    <td><input type="checkbox" class="super-device-row-checkbox" /></td>
                    <td>${user.first_name || ''} ${user.last_name || ''}</td>
                    <td>${devices.length}</td>
                    <td class="action-col">
                      <button class="delete-super-device-btn" style="display:none;" title="Delete User Device">🗑️</button>
                      <span class="delete-confirmation" style="display:none;">
                        <button class="confirm-delete-btn" title="Confirm">✔️</button>
                        <button class="cancel-delete-btn" title="Cancel">❌</button>
                      </span>
                    </td>
                `;
                // Add event listeners
                setupRowEventListeners(row);
                table.appendChild(row);
            });
            
            updateActionColumnVisibility();
            applySupervisorRestrictions();
        }

        // Setup event listeners for table row
        function setupRowEventListeners(row) {
            const checkbox = row.querySelector('.super-device-row-checkbox');
            const deleteBtn = row.querySelector('.delete-super-device-btn');
            const confirmSpan = row.querySelector('.delete-confirmation');
            const confirmBtn = row.querySelector('.confirm-delete-btn');
            const cancelBtn = row.querySelector('.cancel-delete-btn');

            // Prevent row click when clicking checkbox
            checkbox.addEventListener('click', e => e.stopPropagation());

            // Delete button click
            deleteBtn.addEventListener('click', e => {
                e.stopPropagation();
                hideAllDeleteConfirmations();
                deleteBtn.style.display = 'none';
                confirmSpan.style.display = '';
            });

            // Confirm delete
            confirmBtn.addEventListener('click', e => {
                e.stopPropagation();
                row.remove();
                updateActionColumnVisibility();
            });

            // Cancel delete
            cancelBtn.addEventListener('click', e => {
                e.stopPropagation();
                confirmSpan.style.display = 'none';
                deleteBtn.style.display = '';
            });

            // Checkbox change
            checkbox.addEventListener('change', function() {
                deleteBtn.style.display = this.checked ? '' : 'none';
                if (!this.checked) confirmSpan.style.display = 'none';
                updateActionColumnVisibility();
            });
        }

        // Update action column visibility
        function updateActionColumnVisibility() {
            const checkboxes = document.querySelectorAll('.super-device-row-checkbox');
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            const userTable = document.querySelector('.user-table');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            
            if (userTable) userTable.classList.toggle('show-action-col', anyChecked);
            if (deleteAllBtn) deleteAllBtn.style.display = allChecked ? '' : 'none';
        }

        // Hide all delete confirmations
        function hideAllDeleteConfirmations() {
            document.querySelectorAll('.delete-confirmation').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.delete-super-device-btn').forEach(btn => btn.style.display = 'none');
            document.querySelectorAll('.super-device-row-checkbox:checked').forEach(cb => {
                const row = cb.closest('tr');
                if (row) row.querySelector('.delete-super-device-btn').style.display = '';
            });
        }

        // Navigation functions
        function goToUserDevices(address) {
            window.location.href = `user_device_overview.html?address=${address}`;
        }

        function navigate(page) {
            window.location.href = page;
        }

        // Filter users
        function filterUsers() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUserDevices.filter(ud =>
                ud.user.username.toLowerCase().includes(val)
            );
            renderUserDevices(filtered);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 DEBUG: super_device_overview.html DOMContentLoaded');
            
            // Setup select all functionality
            const selectAll = document.getElementById('select-all-super-device');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    document.querySelectorAll('.super-device-row-checkbox').forEach(cb => {
                        cb.checked = selectAll.checked;
                        cb.dispatchEvent(new Event('change'));
                    });
                    updateActionColumnVisibility();
                });
            }


            // Hide delete confirmations when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.action-col')) {
                    hideAllDeleteConfirmations();
                }
            });

            // Load initial data
            loadUserDevices();
        });
    </script>
    <script src="js/auth.js"></script>
    <script src="js/script.js"></script>
</body>
</html>
