<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elevator Errors | EMS</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/stats.css" />
</head>
<body class="dashboard-body">
  <header class="topbar">
    <div class="topbar-logo-title" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
      <img src="assets/adlex_logo.png" alt="ADLEX Logo" class="topbar-logo">
      <h2 class="topbar-title" style="margin:0;flex:1;text-align:center;">Elevator Error</h2>
      <span class="user-role-container">
        <span class="user-icon">üë§</span>
        <span class="userRoleDisplay" id="userRoleDisplay"></span>
      </span>
    </div>
    <button id="darkModeToggle" style="margin-left:20px;">üåô</button>
  </header>
  <!-- Sidebar for normal users/admins -->
  <aside class="sidebar" id="sidebar-normal" style="display:none;">
    <ul>
    <li class="nav-link" onclick="navigate('users.html')">Location</li>
    <li class="nav-link" onclick="navigate('supervisors.html')">User</li>
    <li class="nav-link" onclick="navigate('devices.html')">Devices</li>
    <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
    </ul>
    <div class="logout-link" onclick="logout()">Logout</div>
    <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
</aside>

<!-- Sidebar for supervisors (read-only) -->
<aside class="sidebar" id="sidebar-supervisor" style="display:none;">
    <ul>
    <li class="nav-link active" onclick="navi('super_device_overview.html')">My Devices</li>
    <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
    </ul>
    <div class="logout-link" onclick="logout()">Logout</div>
    <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
</aside>
  <button class="sidebar-hamburger" id="sidebarHamburger" aria-label="Show menu">&#9776;</button>
  <main class="main-content">
    <!-- Device Info Bar -->
    <div id="deviceInfoBar" class="deviceInfoBar">
      <span>Status: <span id="deviceStatus">-</span></span>
      <span>Last Upload: <span id="deviceLastUpload">-</span></span>
      <button id="syncTelemetryBtn" style="margin-left:40px;padding:8px 18px;font-size:1em;background:#2196f3;color:#fff;border:none;border-radius:6px;cursor:pointer;">Sync</button>
    </div>
    <section class="device-detail-section">
      <div class="device-card" id="deviceCard">
        <div class="device-card-header">
            <div class="device-id" id="deviceId" style="font-size:1.5em;font-weight:bold;">-</div>
            <!-- <div class="device-serial" id="deviceSerial">PMRLR24001</div> -->
        </div>
        <div class="device-card-body" ">
          <div class="device-card-body">
            <div class="device-field">
              User Name<br>
              <span id="deviceUser">km</span>
            </div>
            <div class="device-field">
              MAC Address<br>
              <span id="deviceMac">-</span>
            </div>
            <div class="device-field">
              Device ID<br>
              <span id="deviceIdValue">-</span>
            </div>
            <div class="device-field">
              Serial Number<br>
              <span id="deviceSerial">-</span>
            </div>
            <div class="device-field">
              City<br>
              <span id="deviceLocation">-</span>
            </div>
          </div>
          
            
          </div>
    </div>
      <div class="device-tabs">
        <button class="device-tab" id="tabStats">Position Data</button>
        <button class="device-tab active" id="tabAlarms">Alarms</button>
        <button class="device-tab" id="tabMode">Control Data</button>
      </div>
      <div class="device-info-panel">
        <div class="device-info-title"><span class="info-icon">&#9888;</span> Elevator Error Logs</div>
        <div id="errorLogs">
          
          <div class="error-entry"><h4>Error Code: E01</h4><p>Description: Door sensor malfunction.</p></div>
          <div class="error-entry"><h4>Error Code: E02</h4><p>Description: Overweight detected.</p></div>
          <div class="error-entry"><h4>Error Code: E03</h4><p>Description: Emergency stop triggered.</p></div>
        </div>
      </div>
    </section>
  </main>
  <script src="js/script.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get('deviceId');
    const username = sessionStorage.getItem('selectedUsername') || 'NA';
    document.getElementById("deviceUser").textContent = username;
    async function syncAndRenderTelemetry() {
      if (!deviceId) return;
      try {
      const res = await fetch(`/api/device/${deviceId}/sync-telemetry`, { method: 'POST' });
      if (!res.ok) throw new Error('Failed to sync telemetry');
      const telemetry = await res.json();
      renderTelemetryToUI(telemetry);
      await fetchAndRenderUser(telemetry.tb_device_id); // ‚Üê call this
      } catch (e) {
      console.error('Error syncing telemetry:', e);
      alert('Error syncing telemetry: ' + e.message);
      }
      }
      async function fetchAndRenderUser(tb_device_id) {
      try {
      const res = await fetch(`/api/device-user/${tb_device_id}`);
      if (!res.ok) throw new Error('No user assigned');
      const user = await res.json();
      document.getElementById('deviceUser').textContent = user.username || `${user.first_name} ${user.last_name}`;
      } catch (e) {
      console.error('Error loading user info:', e.message);
      document.getElementById('deviceUser').textContent = 'NA';
      }
      }
      const telemetryKeys = [
  'DeviceName','DirCount','DoorAStatus','DoorBStatus','EmergencyAlarm','LastSignalDate','LastSignalTime',
  'Latitude','Location','Longitude','MacAddress','Position','Rpm','SerialNum','Speed','Status',
  'TotalDistanceTravelled','TotalStopCount','TotalTravelTime','TotalWorkTime','AlarmActive','DeviceId'
];
    function renderTelemetryToUI(telemetry) {
      try {
        // Device Card
        //document.getElementById('deviceUser').textContent = telemetry.username || 'NA'; 
        document.getElementById('deviceId').textContent = telemetry.DeviceName || 'NA';
        document.getElementById('deviceIdValue').textContent = telemetry.ID ||telemetry.DeviceId|| 'NA';
        document.getElementById('deviceMac').textContent = telemetry.MacAddress || 'NA';
        document.getElementById('deviceSerial').textContent = telemetry.SerialNum || 'NA';
        document.getElementById('deviceLocation').textContent = telemetry.Location || 'NA';
        document.getElementById('deviceStatus').textContent = telemetry.Status || 'NA';
        document.getElementById('deviceLastUpload').textContent = telemetry.LastSignalDate || 'NA';
        
      } catch (err) {
        console.error('Error rendering telemetry:', err);
        alert('Could not update UI with telemetry data.');
      }
    }
    // Update sync button logic to call renderTelemetryToUI
const syncBtn = document.getElementById('syncTelemetryBtn');
syncBtn.addEventListener('click', async function() {
  if (!deviceId) return alert('No device ID found!');
  syncBtn.disabled = true;
  syncBtn.textContent = 'Syncing...';
  try {
    // Call backend to sync telemetry
    const res = await fetch(`/api/device/${deviceId}/sync-telemetry`, { method: 'POST' });
    if (!res.ok) throw new Error('Failed to sync telemetry');
    const telemetry = await res.json();
    renderTelemetryToUI(telemetry);
    alert('Telemetry synced and displayed!');
  } catch (e) {
    alert('Error syncing telemetry: ' + e.message);
  } finally {
    syncBtn.disabled = false;
    syncBtn.textContent = 'Sync';
  }
});

// Auto-sync telemetry when the page loads
window.addEventListener('DOMContentLoaded', async function() {
  if (!deviceId) return;
  syncBtn.disabled = true;
  syncBtn.textContent = 'Syncing...';
  try {
    // Call backend to sync telemetry
    const res = await fetch(`/api/device/${deviceId}/sync-telemetry`, { method: 'POST' });
    if (!res.ok) throw new Error('Failed to sync telemetry');
    const telemetry = await res.json();
    renderTelemetryToUI(telemetry);
  } catch (e) {
    // Optionally show an error or fallback
    console.error('Error auto-syncing telemetry:', e.message);
  } finally {
    syncBtn.disabled = false;
    syncBtn.textContent = 'Sync';
  }
});
    async function loadDeviceInfo() {
      if (!deviceId) return;
      try {
        const res = await fetch(`/api/device/${deviceId}`);
        if (!res.ok) throw new Error('Device not found');
        const deviceData = await res.json();
        document.getElementById('deviceId').textContent = deviceData.elevator_number || deviceId;
        document.getElementById('deviceUser').textContent = deviceData.username || '';
        document.getElementById('deviceMac').textContent = deviceData.mac_address || '';
      } catch (error) {
        // fallback to static
      }
    }
    loadDeviceInfo();
    document.getElementById('tabStats').onclick = function() {
      if (deviceId) window.location.href = `specific_userdevice.html?deviceId=${deviceId}`;
    };
    document.getElementById('tabAlarms').onclick = function() {
      // Already here
    };
    document.getElementById('tabMode').onclick = function() {
      if (deviceId) window.location.href = `totaldevicestats.html?deviceId=${deviceId}`;
    };
    function navigate(page) { window.location.href = page; }
    function logout() { alert("Logout logic here"); }

    
  </script>
  
</body>
</html>
