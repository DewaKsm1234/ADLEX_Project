<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elevator Errors | EMS</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/stats.css" />
</head>
<body class="dashboard-body">
  <header class="topbar">
    <div class="topbar-logo-title" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
      <img src="assets/logoadlex.png" alt="ADLEX Logo" class="topbar-logo">
      <h2 class="topbar-title" style="margin:0;flex:1;text-align:center;">Elevator Error</h2>
      <span class="user-role-container">
        <span class="user-icon">👤</span>
        <span class="userRoleDisplay" id="userRoleDisplay"></span>
      </span>
    </div>
    <!-- <button id="darkModeToggle" style="margin-left:20px;">🌙</button> -->
  </header>
  <!-- Sidebar for normal users/admins -->
  <aside class="sidebar" id="sidebar-normal" style="display:none;">
    <ul>
    <li class="nav-link active" onclick="navigate('users.html')">Location</li>
    <li class="nav-link" onclick="navigate('supervisors.html')">User</li>
    <li class="nav-link" onclick="navigate('devices.html')">Devices</li>
    <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
    </ul>
    <div class="logout-link" onclick="logout()">Logout</div>
    <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
</aside>

<!-- Sidebar for supervisors (read-only) -->
<aside class="sidebar" id="sidebar-supervisor" style="display:none;">
    <ul>
    <li class="nav-link active" onclick="navi('super_device_overview.html')">My Devices</li>
    <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
    </ul>
    <div class="logout-link" onclick="logout()">Logout</div>
    <button class="sidebar-arrow" id="sidebarArrowSupervisor" aria-label="Hide menu">&#8592;</button>
</aside>
<!-- Sidebar for superadmin -->
<aside class="sidebar" id="sidebar-superadmin" style="display:none;">
  <ul>
    <li class="nav-link" onclick="navigate('superadmin-dashboard.html')">Dashboard</li>
    <li class="nav-link active" onclick="navigate('users.html')">Location Management</li>
    <li class="nav-link" onclick="navigate('supervisors.html')">User Management</li>
    <li class="nav-link" onclick="navigate('devices.html')">Device Management</li>
    <li class="nav-link" onclick="navigate('logs.html')">System Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
  </ul>
  <div class="logout-link" onclick="logout()">Logout</div>
  <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
</aside>
  <button class="sidebar-hamburger" id="sidebarHamburger" aria-label="Show menu">&#9776;</button>
  <main class="main-content">
    <!-- Device Info Bar -->
    <div id="deviceInfoBar" class="deviceInfoBar">
      <span>Status: <span id="deviceStatus">-</span></span>
      <span>Last Upload: <span id="deviceLastUpload">-</span></span>
      </div>
    <section class="device-detail-section">
      <div class="device-card" id="deviceCard">
        
        <div class="device-card-body" ">
          <div class="device-card-body">
            <div class="device-field">
              Location Name<br>
              <span id="deviceUser">-</span>
            </div>
            <div class="device-field">
              MAC Address<br>
              <span id="deviceMac">-</span>
            </div>
            <div class="device-field">
              Device ID<br>
              <span id="deviceIdValue">-</span>
            </div>
            <div class="device-field">
              Serial Number<br>
              <span id="deviceSerial">-</span>
            </div>
            <div class="device-field">
              City<br>
              <span id="deviceLocation">-</span>
            </div>
          </div>
          <div class="device-user-info">
            <div class="user-info-field">User Name<br><span id="deviceUserName">-</span></div>
            <div class="user-info-field">Contact Info<br><span id="deviceUserContact">-</span></div>
          </div>
            
          </div>
    </div>
      <div class="device-tabs">
        <button class="device-tab" id="tabStats">Position Data</button>
        <button class="device-tab active" id="tabAlarms">Alarms</button>
        <button class="device-tab" id="tabMode">Control Data</button>
      </div>
      <div class="device-info-panel">
        <div class="device-info-title"><span class="info-icon">&#9888;</span> Elevator Error Logs</div>
        <div id="errorLogs">
          
          <div class="error-entry"><h4>Error Code: E01</h4><p>Description: Door sensor malfunction.</p></div>
          <div class="error-entry"><h4>Error Code: E02</h4><p>Description: Overweight detected.</p></div>
          <div class="error-entry"><h4>Error Code: E03</h4><p>Description: Emergency stop triggered.</p></div>
        </div>
      </div>
      </div>
    </section>
  </main>
  <script src="js/auth.js"></script>
  <script src="js/script.js"></script>
  <script>
    // Get device ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get('deviceId');

    // Tab navigation functions
    document.getElementById('tabStats').onclick = function() {
      if (deviceId) window.location.href = `specific_userdevice.html?deviceId=${deviceId}`;
    };
    document.getElementById('tabAlarms').onclick = function() {
      // Already on alarms page
    };
    document.getElementById('tabMode').onclick = function() {
      if (deviceId) window.location.href = `totaldevicestats.html?deviceId=${deviceId}`;
    };

    function navigate(page) { 
      window.location.href = page; 
    }
    
    function logout() { 
      alert("Logout logic here"); 
    }

    // --- Main function to load device info and telemetry from backend ---
    async function loadDeviceAndTelemetry(tb_device_id) {
      try {
        const res = await fetch(`/api/device/${tb_device_id}/sync-telemetry`, { 
          method: 'POST', 
          headers: { 'x-user-role': 'admin' } 
        });
        if (!res.ok) throw new Error('Failed to sync telemetry');
        const device = await res.json();
        
        // Update device card fields
        document.getElementById('deviceIdValue').textContent = device.DeviceId || '-';
        document.getElementById('deviceMac').textContent = device.MacAddress || '-';
        document.getElementById('deviceSerial').textContent = device.SerialNum || '-';
        document.getElementById('deviceLocation').textContent = device.Location || '-';
        document.getElementById('deviceStatus').textContent = device.active === true ? 'Active' : 'Inactive';
        
        // Update last upload time with date
        if (device.log_time) {
          const t = new Date(device.log_time);
          const dateStr = t.getFullYear() + '-' + String(t.getMonth()+1).padStart(2,'0') + '-' + String(t.getDate()).padStart(2,'0');
          const timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          document.getElementById('deviceLastUpload').textContent = `${dateStr} ${timeStr}`;
        } else {
          document.getElementById('deviceLastUpload').textContent = 'NA';
        }
        
        // Update error logs based on telemetry data
        updateErrorLogs(device);
        
      } catch (e) {
        console.error('Error loading device and telemetry:', e);
      }
    }

    // --- Function to fetch and render user information ---
    async function fetchAndRenderUser(tb_device_id) {
      try {
        const res = await fetch(`/api/device-user/${tb_device_id}`);
        if (!res.ok) throw new Error('No user assigned');
        const user = await res.json();
        
        document.getElementById('deviceUser').textContent = user.address || 'NA';
        const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
        document.getElementById('deviceUserName').textContent = fullName || 'NA';
        const contactInfo = user.phone || user.email || 'NA';
        document.getElementById('deviceUserContact').textContent = contactInfo;
        
      } catch (e) {
        console.error('Error loading user info:', e.message);
        document.getElementById('deviceUser').textContent = 'NA';
        document.getElementById('deviceUserName').textContent = 'NA';
        document.getElementById('deviceUserContact').textContent = 'NA';
      }
    }

    // --- Function to update error logs based on telemetry data ---
    function updateErrorLogs(device) {
      const errorLogsContainer = document.getElementById('errorLogs');
      let errorEntries = [];

      // Check for various error conditions based on telemetry data
      if (device.ERR && device.ERR !== 'NA' && device.ERR !== '0') {
        errorEntries.push({
          code: 'E01',
          description: `Emergency alarm active: ${device.ERR}`
        });
      }

      if (device.DOORA && device.DOORA !== 'NA' && device.DOORA !== '0') {
        errorEntries.push({
          code: 'E02',
          description: `Door A status issue: ${device.DOORA}`
        });
      }

      if (device.DOORB && device.DOORB !== 'NA' && device.DOORB !== '0') {
        errorEntries.push({
          code: 'E03',
          description: `Door B status issue: ${device.DOORB}`
        });
      }

      // If no errors found, show a message
      if (errorEntries.length === 0) {
        errorEntries.push({
          code: 'OK',
          description: 'No active errors detected'
        });
      }

      // Update the error logs display
      errorLogsContainer.innerHTML = errorEntries.map(error => 
        `<div class="error-entry">
          <h4>Error Code: ${error.code}</h4>
          <p>Description: ${error.description}</p>
        </div>`
      ).join('');
    }

    // --- Page load and auto-sync setup ---
    window.addEventListener('DOMContentLoaded', async function() {
      if (!deviceId) return;
      
      // Initial load
      await loadDeviceAndTelemetry(deviceId);
      await fetchAndRenderUser(deviceId);
      
      // Set up auto-sync every minute
      setInterval(async () => {
        try {
          console.log('🔄 Auto-refreshing elevator error data...');
          await loadDeviceAndTelemetry(deviceId);
          await fetchAndRenderUser(deviceId);
          console.log('✅ Auto-refresh completed successfully');
        } catch (e) {
          console.error('❌ Error in auto-sync:', e.message);
        }
      }, 60000); // 60000ms = 1 minute
    });
  </script>
  
</body>
</html>
