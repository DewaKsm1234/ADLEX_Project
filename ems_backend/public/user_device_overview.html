<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devices Overview</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body, html { background: #f5f7fa; margin: 0; padding: 0; }
        .dashboard-body { min-height: 100vh; }
        .sidebar { width: 200px; padding: 20px 10px; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar li { padding: 12px 16px; border-radius: 5px; margin-bottom: 5px; cursor: pointer; color: #333; }
        .sidebar li.active, .sidebar li:hover { background-color: #007bff; color: white; }
        .main-content { margin-left: 200px; margin-top: 60px; padding: 30px 30px 0 30px; background: #f8f9fa; min-width: 0; min-height: calc(100vh - 60px); box-sizing: border-box; }
        .topbar { background: #007bff; color: #fff; border-radius: 0 0 8px 8px; }
        .topbar h2 { margin: 0; font-size: 2em; letter-spacing: 1px; }
        .search-panel { display: flex; align-items: center; gap: 10px; }
        .search-box { background: #fff; border-radius: 20px; padding: 5px 10px; display: flex; align-items: center; }
        .search-box input { border: none; outline: none; background: transparent; padding: 5px; min-width: 180px; }
        .search-icon { margin-left: 5px; color: #007bff; }
        .register-btn { background: #fff; color: #007bff; border: none; padding: 8px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em; margin-left: 10px; }
        .register-btn:hover { background: #e6f0ff; }
        .table-container { background: #fff; border-radius: 8px; margin: 30px 20px 0 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .user-table { width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 8px; overflow: hidden; }
        .user-table th, .user-table td { padding: 16px 18px; border-bottom: 1px solid #eee; text-align: left; font-size: 1em; }
        .user-table th { background: #f8f9fa; color: #333; font-weight: 600; }
        .user-table tr:last-child td { border-bottom: none; }
        .user-table td a { color: #007bff; text-decoration: none; font-weight: 500; }
        .user-table td a:hover { text-decoration: underline; }
        .user-table td .add-device-link { color: #007bff; text-decoration: underline; cursor: pointer; }
        .user-table td .add-device-link:hover { color: #0056b3; }
        .user-table td .user-link { cursor: pointer; color: #222; font-weight: 500; }
        .user-table td .user-link:hover { color: #007bff; text-decoration: underline; }
        .user-table tr:hover { background: #007bff !important; color: #fff; }
        .user-table tr:hover td, .user-table tr:hover a { color: #fff !important; }
        @media (max-width: 900px) {
            .table-container { margin: 0; }
            .user-table th, .user-table td { padding: 10px 6px; font-size: 0.95em; }
        }
        .logout-link {
            color: #e74c3c !important;
            font-weight: bold;
            margin-top: 40px;
        }
        .logout-link:hover {
            background: #ffeaea !important;
            color: #c0392b !important;
        }
        th.action-col, td.action-col { display: none; }
        .show-action-col th.action-col, .show-action-col td.action-col { display: table-cell !important; }
        #delete-all-btn { display: none; margin: 10px 0; background: #e74c3c; color: #fff; border: none; padding: 8px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em; }
        #delete-all-btn:hover { background: #c0392b; }
        .confirm-delete-btn, .cancel-delete-btn { display: inline-block; border: none; background: none; font-size: 1.2em; cursor: pointer; margin-left: 4px; }
        .confirm-delete-btn { color: #28a745; }
        .cancel-delete-btn { color: #e74c3c; }
    </style>
</head>
<body class="dashboard-body">
    <header class="topbar">
        <div class="topbar-logo-title" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
            <img src="assets/adlex_logo.png" alt="ADLEX Logo" class="topbar-logo">
            <h2 class="topbar-title" style="margin:0;flex:1;text-align:center;">Devices Overview</h2>
            <span style="width:48px;"></span>
        </div>
    </header>
    <aside class="sidebar" id="sidebar">
        <div class="menu-title">Menu</div>
        <ul>
            <li class="nav-link active" onclick="navigate('users.html')">Users</li>
            <li class="nav-link" onclick="navigate('supervisors.html')">Supervisors</li>
            <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
            <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
        </ul>
        <div class="logout-link" onclick="logout()">Logout</div>
        <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
    </aside>
    <button class="sidebar-hamburger" id="sidebarHamburger" aria-label="Show menu">&#9776;</button>
    <main class="main-content">
        <div class="top-actions-bar" style="display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-bottom:20px;">
            <div class="search-panel">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search" oninput="filterDevices()" />
                    <span class="search-icon">üîç</span>
                </div>
            </div>
            <button class="register-btn" id="addDeviceBtn">Add Device</button>
        </div>
        <div class="user-label" id="userLabel" style="margin:30px; font-size:1.6em; font-weight:bold;"></div>
        <div class="table-container">
            <button id="delete-all-btn">Delete All</button>
            <table class="user-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-user-device" /></th>
                        <th>Device ID</th>
                        <th>Elevator Number</th>
                        <th>Serial No</th>
                        <th>MAC Address</th>
                        <th>Location</th>
                        <th>Connection</th>
                        <th class="action-col">Action</th>
                    </tr>
                </thead>
                <tbody id="device-table-body">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
    </main>
    <!-- Add Device Modal -->
    <div id="addDeviceModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:200; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:12px; width:480px; max-width:95vw; box-shadow:0 8px 32px rgba(0,0,0,0.18); margin:auto; position:relative;">
            <div style="background:#f4f4f4; border-radius:12px 12px 0 0; padding:18px 28px; display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.5em; color:#007bff;">&#128230;</span>
                <span style="font-size:1.2em; font-weight:600;">Add New Device</span>
            </div>
            <form id="addDeviceForm" style="padding:28px 28px 18px 28px;">
                <fieldset style="border:none; margin:0 0 18px 0;">
                    <legend style="font-weight:600; color:#007bff; margin-bottom:10px; font-size:1em;">
                        <span style="margin-right:6px;">&#128295;</span>Device Info
                    </legend>
                    <div style="display:flex; gap:12px; margin-bottom:12px;">
                        <input type="text" name="elevator_number" placeholder="e.g., E010255" required style="flex:1; padding:10px; border-radius:6px; border:1px solid #ccc;" />
                        <input type="text" name="serial_number" placeholder="e.g., PUMRL784001" required style="flex:1; padding:10px; border-radius:6px; border:1px solid #ccc;" />
                    </div>
                    <div style="display:flex; gap:12px; margin-bottom:12px;">
                        <input type="text" name="device_id" placeholder="Enter Device ID" required style="flex:1; padding:10px; border-radius:6px; border:1px solid #ccc;" />
                        <input type="text" name="mac_address" placeholder="68:27:ea:43:1c:1f" required style="flex:1; padding:10px; border-radius:6px; border:1px solid #ccc;" />
                    </div>
                    <input type="text" name="location" placeholder="Enter site or Location" required style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-bottom:12px;" />
                </fieldset>
                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" onclick="closeAddDeviceModal()" style="padding:10px 18px; border:none; border-radius:6px; background:#eee; color:#333; font-weight:500; cursor:pointer;">Cancel</button>
                    <button type="submit" style="padding:10px 18px; border:none; border-radius:6px; background:#007bff; color:#fff; font-weight:600; cursor:pointer;">Submit</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Get username from query param
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        let allDevices = [];
        let selectedRow = null;
        document.getElementById('userLabel').textContent = username || 'User';
        document.getElementById('addDeviceBtn').onclick = function() {
            openAddDeviceModal();
        };
        async function loadDevices() {
            if (!username) return;
            try {
                const res = await fetch(`/api/user-devices/${username}`);
                const devices = await res.json();
                allDevices = devices;
                renderDevices(devices);
            } catch {
                document.getElementById('device-table-body').innerHTML = '<tr><td colspan="7">Error loading devices</td></tr>';
            }
        }
        function renderDevices(devices) {
            const table = document.getElementById('device-table-body');
            table.innerHTML = '';
            devices.forEach((device, idx) => {
                const row = document.createElement('tr');
                row.onclick = () => goToDevice(device.device_id);
                row.innerHTML = `
                    <td><input type="checkbox" class="user-device-row-checkbox" /></td>
                    <td>${device.device_id}</td>
                    <td>${device.elevator_number || ''}</td>
                    <td>${device.serial_number || ''}</td>
                    <td>${device.mac_address || ''}</td>
                    <td>${device.location || ''}</td>
                    <td><span class="status-pill">${device.status || 'Online'}</span></td>
                    <td class="action-col">
                      <button class="delete-user-device-btn" style="display:none;" title="Delete Device">üóëÔ∏è</button>
                      <span class="delete-confirmation" style="display:none;">
                        <button class="confirm-delete-btn" title="Confirm">‚úîÔ∏è</button>
                        <button class="cancel-delete-btn" title="Cancel">‚ùå</button>
                      </span>
                    </td>
                `;
                row.querySelector('.user-device-row-checkbox').addEventListener('click', e => e.stopPropagation());
                row.querySelector('.delete-user-device-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    hideAllDeleteConfirmations();
                    row.querySelector('.delete-user-device-btn').style.display = 'none';
                    row.querySelector('.delete-confirmation').style.display = '';
                });
                row.querySelector('.confirm-delete-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    row.remove();
                    updateActionColumnVisibility();
                });
                row.querySelector('.cancel-delete-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    row.querySelector('.delete-confirmation').style.display = 'none';
                    row.querySelector('.delete-user-device-btn').style.display = '';
                });
                row.querySelector('.user-device-row-checkbox').addEventListener('change', function() {
                    row.querySelector('.delete-user-device-btn').style.display = this.checked ? '' : 'none';
                    if (!this.checked) row.querySelector('.delete-confirmation').style.display = 'none';
                    updateActionColumnVisibility();
                });
                table.appendChild(row);
            });
            updateActionColumnVisibility();
        }
        function hideAllDeleteConfirmations() {
            document.querySelectorAll('.delete-confirmation').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.delete-user-device-btn').forEach(btn => btn.style.display = 'none');
            document.querySelectorAll('.user-device-row-checkbox:checked').forEach(cb => {
                const row = cb.closest('tr');
                if (row) row.querySelector('.delete-user-device-btn').style.display = '';
            });
        }
        function goToDevice(deviceId) {
            window.location.href = `specific_userdevice.html?deviceId=${deviceId}`;
        }
        function viewDevice(deviceId) {
            window.location.href = `user_device_overview.html?deviceId=${deviceId}`;
        }
        function viewElevator(elevatorNumber) {
            alert('Elevator details for: ' + elevatorNumber); // Placeholder
        }
        function navigate(page) {
            window.location.href = page;
        }
        function filterDevices() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allDevices.filter(d =>
                (d.device_id && d.device_id.toLowerCase().includes(val)) ||
                (d.elevator_number && d.elevator_number.toLowerCase().includes(val)) ||
                (d.serial_number && d.serial_number.toLowerCase().includes(val)) ||
                (d.mac_address && d.mac_address.toLowerCase().includes(val)) ||
                (d.location && d.location.toLowerCase().includes(val))
            );
            renderDevices(filtered);
        }
        // Modal logic
        const addDeviceModal = document.getElementById('addDeviceModal');
        const addDeviceBtn = document.getElementById('addDeviceBtn');
        const addDeviceForm = document.getElementById('addDeviceForm');

        function openAddDeviceModal() {
            addDeviceModal.style.display = 'flex';
        }
        function closeAddDeviceModal() {
            addDeviceModal.style.display = 'none';
            addDeviceForm.reset();
        }
        addDeviceForm.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(addDeviceForm);
            const data = {
                username,
                elevator_number: formData.get('elevator_number'),
                serial_number: formData.get('serial_number'),
                device_id: formData.get('device_id'),
                mac_address: formData.get('mac_address'),
                location: formData.get('location'),
                device_info: null // or you can add a field if needed
            };
            try {
                const res = await fetch('/api/assign-device', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeAddDeviceModal();
                    await loadDevices(); // Refresh device list
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to add device');
                }
            } catch (err) {
                alert('Failed to add device');
            }
        };
        function logout() {
            // Optionally clear local/session storage if you use it for authentication
            // localStorage.clear();
            // sessionStorage.clear();
            window.location.href = "login.html";
        }
        // Sidebar toggle logic
        document.getElementById('sidebarArrow').onclick = function() {
            var sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        };
        document.getElementById('sidebarHamburger').onclick = function() {
            var sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        };
        document.addEventListener('DOMContentLoaded', function() {
            const selectAll = document.getElementById('select-all-user-device');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            selectAll && selectAll.addEventListener('change', function() {
                document.querySelectorAll('.user-device-row-checkbox').forEach(cb => {
                    cb.checked = selectAll.checked;
                    cb.dispatchEvent(new Event('change'));
                });
                updateActionColumnVisibility();
            });
            deleteAllBtn.addEventListener('click', function() {
                document.querySelectorAll('.user-device-row-checkbox:checked').forEach(cb => {
                    const row = cb.closest('tr');
                    if (row) {
                        row.querySelector('.delete-user-device-btn').style.display = 'none';
                        row.querySelector('.delete-confirmation').style.display = '';
                    }
                });
            });
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.action-col')) hideAllDeleteConfirmations();
            });
        });
        function updateActionColumnVisibility() {
            const anyChecked = Array.from(document.querySelectorAll('.user-device-row-checkbox')).some(cb => cb.checked);
            const allChecked = Array.from(document.querySelectorAll('.user-device-row-checkbox')).length > 0 && Array.from(document.querySelectorAll('.user-device-row-checkbox')).every(cb => cb.checked);
            document.querySelector('.user-table').classList.toggle('show-action-col', anyChecked);
            document.getElementById('delete-all-btn').style.display = allChecked ? '' : 'none';
        }
        loadDevices();
    </script>
</body>
</html>
