<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Device Logs</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    .calendar-container { display: flex; gap: 10px; margin-bottom: 10px; }
    .download-btn {padding:5px 3px;font-size:1em;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;}
   </style>
</head>
<body>
  <!-- <h2>Device Logs</h2> -->
  <!-- Topbar/Header -->
  <header class="topbar">
    <div class="topbar-logo-title" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
      <img src="assets/adlex_logo.png" alt="ADLEX Logo" class="topbar-logo">
      <h2 class="topbar-title" style="margin:0;flex:1;text-align:center;">Logs</h2>
      <span class="userRoleDisplay" id="userRoleDisplay"></span>
    </div>
    <button id="darkModeToggle" style="margin-left:20px;">üåô</button>
  </header>
  <!-- Sidebar for normal users/admins -->
<aside class="sidebar" id="sidebar-normal" style="display:none;">
  
  <ul>
    <li class="nav-link" onclick="navigate('users.html')">Location</li>
    <li class="nav-link" onclick="navigate('supervisors.html')">Supervisor</li>
    <li class="nav-link" onclick="navigate('devices.html')">Devices</li>
    <li class="nav-link active" onclick="navigate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
    
  </ul>
  <div class="logout-link" onclick="logout()">Logout</div>
  <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
</aside>

<!-- Sidebar for supervisors (read-only) -->
<aside class="sidebar" id="sidebar-supervisor" style="display:none;">
  <ul>
    <li class="nav-link" onclick="navigate('super_device_overview.html')">My Devices</li>
    <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
  </ul>
  <div class="logout-link" onclick="logout()">Logout</div>
  <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
</aside>
  <button class="sidebar-hamburger" id="sidebarHamburger" aria-label="Show menu">&#9776;</button>
  <main class="main-content">
    <!-- Top actions: search and register -->
    <div class="top-actions-bar" style="display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-bottom:20px;">
      <div class="calendar-container">
        <label>From: <input type="date" id="fromDate" /></label>
        <label>To: <input type="date" id="toDate" /></label>
        <button id="downloadAllBtn" class="download-btn">Download All</button>
      </div>
      <div class="search-panel">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search" oninput="filterLogs()" />
          <span class="search-icon">üîç</span>
          
        </div>
      </div>
    </div>
  

  <table id="logsTable">
    <thead>
      <tr>
        <th>Sr No</th>
        <th>Device ID</th>
        <th>Device Name</th>
        <th>City</th>
        <th>Current</th>
        <th>DC Bus</th>
        <th>Speed</th>
        <th>RPM</th>
        <th>Position</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="logsBody"></tbody>
  </table>

  <script>
    let allLogsData = [];
    function renderLogsTable(data) {
      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = '';
      data.forEach((device, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${idx + 1}</td>
          <td>${device.DeviceId || device.tb_device_id || '-'}</td>
          <td>${device.device_name || '-'}</td>
          <td>${device.city || '-'}</td>
          <td>${device.Current ?? device.current ?? 0}</td>
          <td>${device.dcbus ?? 0}</td>
          <td>${device.speed ?? 0}</td>
          <td>${device.rpm ?? 0}</td>
          <td>${device.position ?? 0}</td>
          <td>
            <button class="download-btn" onclick="downloadLogs('${device.tb_device_id}')">Download</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function fetchLatestLogs() {
      let data;
      const role = localStorage.getItem('userRole');
      if (role === 'supervisor') {
        const supervisor_id = sessionStorage.getItem('supervisor_id');
        if (!supervisor_id) {
          alert('Supervisor session expired. Please log in again.');
          window.location.href = 'login.html';
          return;
        }
        const res = await fetch(`/api/logs/supervisor-latest?supervisor_id=${supervisor_id}`);
        data = await res.json();
      } else {
        const res = await fetch('/api/logs/latest');
        data = await res.json();
      }
      allLogsData = data;
      renderLogsTable(data);
    }

    async function downloadLogs(tb_device_id) {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      if (!from || !to) {
        alert('Please select both From and To dates');
        return;
      }
      window.location.href = `/api/logs/download/${tb_device_id}?from=${from}&to=${to}`;
    }

    document.getElementById('downloadAllBtn').addEventListener('click', downloadAllLogs);

    async function downloadAllLogs() {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      if (!from || !to) {
        alert('Please select both From and To dates');
        return;
      }
      window.location.href = `/api/logs/download-all?from=${from}&to=${to}`;
    }

    function filterLogs() {
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const filtered = allLogsData.filter(device =>
        (device.device_name && device.device_name.toLowerCase().includes(search)) ||
        (device.city && device.city.toLowerCase().includes(search)) ||
        (device.tb_device_id && device.tb_device_id.toLowerCase().includes(search))
      );
      renderLogsTable(filtered);
    }

    // Refresh logs every 30s
    fetchLatestLogs();
    setInterval(fetchLatestLogs, 30000);
    document.getElementById('searchInput').oninput = filterLogs;
  </script>
  <script src="js/script.js"></script>
</body>
</html>
