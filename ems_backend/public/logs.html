<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Device Logs</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
      input[type="date"] {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        background-color: #f9f9f9;
        transition: border-color 0.3s, box-shadow 0.3s;
      }
    
      input[type="date"]:focus {
        border-color: #4A90E2;
        box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
        outline: none;
        background-color: #fff;
      }
    
      input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        filter: invert(0.5);
      }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    .calendar-container { display: flex; gap: 10px; }
    .download-btn {padding:5px 3px;font-size:1em;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;}
   </style>
</head>
<body class="dashboard-body">
  <main class="main-content">
    <div class="top-actions-bar" style="display:flex;justify-content:flex-end;align-items:center;gap:10px;  ">
      <div class="search-panel">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search" oninput="filterLogs()" maxlength="30"/>
          <span class="search-icon">üîç</span>
        </div>
      </div>
      <div class="calendar-container">
        <label>From: <input type="date" id="fromDate" /></label>
        <label>To: <input type="date" id="toDate" /></label>
        <select id="downloadFormat">
          <option value="csv">CSV</option>
          <option value="xls">Excel (XLSX)</option>
          <!-- <option value="pdf">PDF</option> -->
        </select>
        <button id="downloadSelectedBtn" class="download-btn">Download</button>
      </div>
    </div>
  

  <table id="logsTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="SelectAllDevices"></th>
        <th>Sr No</th>
        <th>Device ID</th>
        <th>Device Name</th>
        <th>Address</th>
        <th>City</th>
      </tr>
    </thead>
    <tbody id="logsBody"></tbody>
  </table>

  <script>
    let allLogsData = [];
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0]; // format: YYYY-MM-DD
      document.getElementById('fromDate').setAttribute('max', today);
      document.getElementById('toDate').setAttribute('max', today);
    });
    
    function renderLogsTable(data) {
      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = '';
      data.forEach((device, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="device-row-checkbox" data-idx="${idx}"></td>
          <td>${idx + 1}</td>
          <td>${device.ID || device.DeviceId || '-'}</td>
          <td>${device.device_name || '-'}</td>
          <td>${device.address || '-'}</td>
          <td>${device.city || '-'}</td>
          <!-- <td>${device.Current ?? device.current ?? 0}</td>
          <td>${device.dcbus ?? 0}</td>
          <td>${device.speed ?? 0}</td>
          <td>${device.rpm ?? 0}</td>
          <td>${device.position ?? 0}</td> -->
        `;
        tbody.appendChild(row);
      });
      
              // Add select all logic
        const selectAll = document.getElementById('SelectAllDevices');
        selectAll.checked = false;
        selectAll.onclick = function () {
          const visibleCheckboxes = Array.from(document.querySelectorAll('.device-row-checkbox')).filter(cb => cb.closest('tr').style.display !== 'none');
          
          if (selectAll.checked && visibleCheckboxes.length > 10) {
            alert('You can download logs for a maximum of 10 devices at a time');
            selectAll.checked = false;
            return;
          }
          
          visibleCheckboxes.forEach(cb => cb.checked = selectAll.checked);
        };
        // Uncheck select all if any checkbox is manually unchecked
        tbody.querySelectorAll('.device-row-checkbox').forEach(cb => {
          cb.addEventListener('change', function () {
            if (!this.checked) selectAll.checked = false;
          });
        });
        
        // Add device limit check for individual checkboxes
        tbody.querySelectorAll('.device-row-checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('.device-row-checkbox:checked').length;
            if (checkedCount > 10) {
              this.checked = false;
              alert('You can download logs for a maximum of 10 devices at a time');
              return;
            }
          });
        });
    }
    function validateDates(fromDateStr, toDateStr) {
      let fromDate = new Date(fromDateStr);
      const toDate = new Date(toDateStr);
      const now = new Date();
    
      if (isNaN(fromDate) || isNaN(toDate)) {
        alert("Please enter valid From and To dates.");
        return false;
      }
    
      if (fromDate > toDate) {
        alert("From Date cannot be after To Date.");
        return false;
      }
    
      if (toDate > now) {
        alert("To Date cannot be in the future.");
        return false;
      }
    
      return true;
    }
    async function fetchLatestLogs() {
      let data;
      const role = localStorage.getItem('userRole');
      if (role === 'supervisor') {
        const supervisor_id = localStorage.getItem('userId'); // ‚úÖ use localStorage
        if (!supervisor_id) {
          alert('Session expired. Please log in again.');
          localStorage.clear();
          window.location.href = 'login.html';
          return;
        }
        const res = await fetch(`/api/logs/supervisor-latest?supervisor_id=${supervisor_id}`);
        data = await res.json();
      } else {
        const res = await fetch('/api/logs/latest');
        data = await res.json();
      }
      allLogsData = data;
      renderLogsTable(data);
    }
    
  
  
    function filterLogs() {
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const filtered = allLogsData.filter(device =>
        (device.device_name && device.device_name.toLowerCase().includes(search)) ||
        (device.city && device.city.toLowerCase().includes(search)) ||
        (device.tb_device_id && device.tb_device_id.toLowerCase().includes(search)) ||
        (device.address && device.address.toLowerCase().includes(search))
      );
      renderLogsTable(filtered);
    }
  
    fetchLatestLogs();
    setInterval(fetchLatestLogs, 30000);
    document.getElementById('searchInput').oninput = filterLogs;
    document.getElementById('downloadSelectedBtn').onclick = function() {
  let from = document.getElementById('fromDate').value;
  let to = document.getElementById('toDate').value;
  const format = document.getElementById('downloadFormat').value;

  if (!from || !to) {
    alert('Please select both From and To dates');
    return;
  }
  // ‚úÖ Add time boundaries for same-day case
  if (from === to) {
    from += ' 00:00:00';
    to += ' 23:59:59';
  }
  // ‚úÖ NEW: Validate the date range
  if (!validateDates(from, to)) {
    return; // üö´ Stop if dates are invalid
  }
  
  const checkboxes = Array.from(document.querySelectorAll('.device-row-checkbox:checked'));
  if (!checkboxes.length) {
    alert('Please select at least one device to download logs');
    return;
  }

  // Only include checked checkboxes that are in visible rows
  const selectedRows = checkboxes
    .map(cb => cb.closest('tr'))
    .filter(row => row && row.style.display !== 'none');

  if (!selectedRows.length) {
    alert('No visible devices selected.');
    return;
  }

  const selectedIds = selectedRows.map(row => {
    const idx = parseInt(row.querySelector('.device-row-checkbox').dataset.idx);
    const device = allLogsData[idx];
    return device && (device.tb_device_id || device.DeviceId);
  }).filter(Boolean);

  if (!selectedIds.length) {
    alert('No valid device IDs found.');
    return;
  }

  // ‚úÖ Trigger the actual download
  window.location.href = `/api/logs/download-selected?ids=${selectedIds.join(',')}&from=${from}&to=${to}&format=${format}`;
};

  </script>
  <script src="js/auth.js"></script>
  <script src="js/script.js"></script>
  <script src="js/components.js"></script>
  <script>
    // Initialize components for this page
    document.addEventListener('DOMContentLoaded', function() {
      loadPageComponents('Logs', 'logs.html');
    });
  </script>
</body>
</html>
