<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Device Logs</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    .calendar-container { display: flex; gap: 10px; }
    .download-btn {padding:5px 3px;font-size:1em;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;}
   </style>
</head>
<body>
  <!-- <h2>Device Logs</h2> -->
  <!-- Topbar/Header -->
  <header class="topbar">
    <div class="topbar-logo-title" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
      <img src="assets/adlex_logo.png" alt="ADLEX Logo" class="topbar-logo">
      <h2 class="topbar-title" style="margin:0;flex:1;text-align:center;">Logs</h2>
      <span class="user-role-container">
        <span class="user-icon">üë§</span>
        <span class="userRoleDisplay" id="userRoleDisplay"></span>
      </span>
    </div>
    <button id="darkModeToggle" style="margin-left:20px;">üåô</button>
  </header>
  <!-- Sidebar for normal users/admins -->
<aside class="sidebar" id="sidebar-normal" style="display:none;">
  
  <ul>
    <li class="nav-link" onclick="navigate('users.html')">Location</li>
    <li class="nav-link" onclick="navigate('supervisors.html')">User</li>
    <li class="nav-link" onclick="navigate('devices.html')">Devices</li>
    <li class="nav-link active" onclick="navigate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
    
  </ul>
  <div class="logout-link" onclick="logout()">Logout</div>
  <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
</aside>

<!-- Sidebar for supervisors (read-only) -->
<aside class="sidebar" id="sidebar-supervisor" style="display:none;">
  <ul>
    <li class="nav-link" onclick="navi('super_device_overview.html')">My Devices</li>
    <li class="nav-link active" onclick="navigaate('logs.html')">Logs</li>
    <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
  </ul>
  <div class="logout-link" onclick="logout()">Logout</div>
  <button class="sidebar-arrow" id="sidebarArrowSupervisor" aria-label="Hide menu">&#8592;</button>
</aside>
  <button class="sidebar-hamburger" id="sidebarHamburger" aria-label="Show menu">&#9776;</button>
  <main class="main-content">
    <!-- Top actions: search and register -->
     
    <div class="top-actions-bar" style="display:flex;justify-content:flex-end;align-items:center;gap:10px;  ">
      <div class="search-panel">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search" oninput="filterLogs()" />
          <span class="search-icon">üîç</span>
        </div>
      </div>
      <div class="calendar-container">
        <label>From: <input type="date" id="fromDate" /></label>
        <label>To: <input type="date" id="toDate" /></label>
        <select id="downloadFormat">
          <option value="csv">CSV</option>
          <option value="xls">Excel (XLSX)</option>
          <!-- <option value="pdf">PDF</option> -->
        </select>
        <button id="downloadSelectedBtn" class="download-btn">Download</button>
      </div>
    </div>
  

  <table id="logsTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="SelectAllDevices"></th>
        <th>Sr No</th>
        <th>Device ID</th>
        <th>Device Name</th>
        <th>Address</th>
        <th>City</th>
      </tr>
    </thead>
    <tbody id="logsBody"></tbody>
  </table>

  <script>
    let allLogsData = [];
  
    function renderLogsTable(data) {
      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = '';
      data.forEach((device, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="device-row-checkbox" data-idx="${idx}"></td>
          <td>${idx + 1}</td>
          <td>${device.ID || device.DeviceId || '-'}</td>
          <td>${device.device_name || '-'}</td>
          <td>${device.address || '-'}</td>
          <td>${device.city || '-'}</td>
          <!-- <td>${device.Current ?? device.current ?? 0}</td>
          <td>${device.dcbus ?? 0}</td>
          <td>${device.speed ?? 0}</td>
          <td>${device.rpm ?? 0}</td>
          <td>${device.position ?? 0}</td> -->
        `;
        tbody.appendChild(row);
      });
  
      // Add select all logic
      const selectAll = document.getElementById('SelectAllDevices');
      selectAll.checked = false;
      selectAll.onclick = function () {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.device-row-checkbox')).filter(cb => cb.closest('tr').style.display !== 'none');
        visibleCheckboxes.forEach(cb => cb.checked = selectAll.checked);
      };
      // Uncheck select all if any checkbox is manually unchecked
      tbody.querySelectorAll('.device-row-checkbox').forEach(cb => {
        cb.addEventListener('change', function () {
          if (!this.checked) selectAll.checked = false;
        });
      });
    }
  
    async function fetchLatestLogs() {
      let data;
      const role = localStorage.getItem('userRole');
      if (role === 'supervisor') {
        const supervisor_id = sessionStorage.getItem('supervisor_id');
        if (!supervisor_id) {
          alert('Supervisor session expired. Please log in again.');
          window.location.href = 'login.html';
          return;
        }
        const res = await fetch(`/api/logs/supervisor-latest?supervisor_id=${supervisor_id}`);
        data = await res.json();
      } else {
        const res = await fetch('/api/logs/latest');
        data = await res.json();
      }
      allLogsData = data;
      renderLogsTable(data);
    }
  
  
    function filterLogs() {
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const filtered = allLogsData.filter(device =>
        (device.device_name && device.device_name.toLowerCase().includes(search)) ||
        (device.city && device.city.toLowerCase().includes(search)) ||
        (device.tb_device_id && device.tb_device_id.toLowerCase().includes(search)) ||
        (device.address && device.address.toLowerCase().includes(search))
      );
      renderLogsTable(filtered);
    }
  
    fetchLatestLogs();
    setInterval(fetchLatestLogs, 30000);
    document.getElementById('searchInput').oninput = filterLogs;
    document.getElementById('downloadSelectedBtn').onclick = function() {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      const format = document.getElementById('downloadFormat').value;
      if (!from || !to) {
        alert('Please select both From and To dates');
        return;
      }
      const checkboxes = Array.from(document.querySelectorAll('.device-row-checkbox:checked'));
      if (!checkboxes.length) {
        alert('Please select at least one device to download logs');
        return;
      }
      // Only include checked checkboxes that are in visible rows
      const selectedRows = checkboxes
        .map(cb => cb.closest('tr'))
        .filter(row => row && row.style.display !== 'none');
      if (!selectedRows.length) {
        alert('No visible devices selected.');
        return;
      }
      const selectedIds = selectedRows.map(row => {
        const idx = parseInt(row.querySelector('.device-row-checkbox').dataset.idx);
        const device = allLogsData[idx];
        return device && (device.tb_device_id || device.DeviceId);
      }).filter(Boolean);
      if (!selectedIds.length) {
        alert('No valid device IDs found.');
        return;
      }
      // Download from server API as a single zip file
      window.location.href = `/api/logs/download-selected?ids=${selectedIds.join(',')}&from=${from}&to=${to}&format=${format}`;
    };
  </script>
  
  <script src="js/script.js"></script>
</body>
</html>
