<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Total Device Stats | EMS</title>
<!-- <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet" /> -->
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/stats.css" />
</head>
<body class="dashboard-body">
  <main class="main-content">
    <!-- Device Info Bar -->
    <div id="deviceInfoBar" class="deviceInfoBar">
    <span>Status: <span id="deviceStatus">-</span></span>
    <span>Last Upload: <span id="deviceLastUpload">-</span></span>
  </div>
  <section class="device-detail-section">
    <div class="device-card" id="deviceCard">
      <div class="device-card-body">
        <div class="device-field">Location Name<br><span id="deviceUser">-</span></div>
        <div class="device-field">MAC Address<br><span id="deviceMac">-</span></div>
        <div class="device-field">Device ID<br><span id="deviceIdValue">-</span></div>
        <div class="device-field">Serial Number<br><span id="deviceSerial">-</span></div>
        <div class="device-field">Location<br><span id="deviceLocation">-</span></div>
      </div>
      <div class="device-user-info">
        <div class="user-info-field">User Name<br><span id="deviceUserName">-</span></div>
        <div class="user-info-field">Contact Info<br><span id="deviceUserContact">-</span></div>
      </div>
    </div>
    <div class="device-tabs">
      <button class="device-tab " id="tabStats">Position Data</button>
      <button class="device-tab" id="tabAlarms">Alarms</button>
      <button class="device-tab active" id="tabMode">Control Data</button>
    </div>
  </section>
  <!-- <div class="device-map">
    <iframe src="https://maps.google.com/maps?q=Samsan%20Technische%20Labs%20Pvt%20Ltd%20(Kothrud)&t=&z=15&ie=UTF8&iwloc=&output=embed"></iframe>
  </div> -->
  <div class="stats-grid">
    <div class="stat-item"><div class="stat-icon">⚡</div><div class="stat-label">DC Bus (Volts)</div><div class="stat-value" id="stat-DCBus">-</div></div>
    <div class="stat-item"><div class="stat-icon">⚡</div><div class="stat-label">Current (Amps)</div><div class="stat-value" id="stat-Current">-</div></div>
    <div class="stat-item"><div class="stat-icon">🕒</div><div class="stat-label">Speed (m/s)</div><div class="stat-value" id="stat-Speed">-</div></div>
    <div class="stat-item"><div class="stat-icon">📅</div><div class="stat-label">RPM (Rev/min)</div><div class="stat-value" id="stat-Rpm">-</div></div>
    <div class="stat-item"><div class="stat-icon">🚨</div><div class="stat-label">Position (m)</div><div class="stat-value" id="stat-Position">-</div></div>
    <div class="stat-item"><div class="stat-icon">🚨</div><div class="stat-label">Current Floor</div><div class="stat-value" id="stat-Floor">-</div></div>
  </div>
</div>
<script src="js/auth.js"></script>
<script src="js/script.js"></script>
<script src="js/components.js"></script>
<script>
// Initialize components for this page
document.addEventListener('DOMContentLoaded', function() {
  loadPageComponents('Device Statistics', 'totaldevicestats.html');
});

// Get device ID from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const deviceId = urlParams.get('deviceId');

// Tab navigation functions
document.getElementById('tabStats').onclick = function() {
  if (deviceId) window.location.href = `specific_userdevice.html?deviceId=${deviceId}`;
};
document.getElementById('tabAlarms').onclick = function() {
  if (deviceId) window.location.href = `elevatorerror.html?deviceId=${deviceId}`;
};
document.getElementById('tabMode').onclick = function() {
  // Stay on current page
};

function navigate(page) {
  window.location.href = page;
}

// --- Main function to load device info and telemetry from backend ---
async function loadDeviceAndTelemetry(tb_device_id) {
  try {
    const res = await fetch(`/api/device/${tb_device_id}/sync-telemetry`, { 
      method: 'POST', 
      headers: { 'x-user-role': 'admin' } 
    });
    if (!res.ok) throw new Error('Failed to sync telemetry');
    const device = await res.json();
    
    // Update device card fields
    document.getElementById('deviceIdValue').textContent = device.DeviceId || '-';
    document.getElementById('deviceMac').textContent = device.MacAddress || '-';
    document.getElementById('deviceSerial').textContent = device.SerialNum || '-';
    document.getElementById('deviceLocation').textContent = device.Location || '-';
    document.getElementById('deviceStatus').textContent = device.active === true ? 'Active' : 'Inactive';
    
    // Update last upload time with date
    if (device.log_time) {
      const t = new Date(device.log_time);
      const dateStr = t.getFullYear() + '-' + String(t.getMonth()+1).padStart(2,'0') + '-' + String(t.getDate()).padStart(2,'0');
      const timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('deviceLastUpload').textContent = `${dateStr} ${timeStr}`;
    } else {
      document.getElementById('deviceLastUpload').textContent = 'NA';
    }
    
    // Update stats grid
    document.getElementById('stat-DCBus').textContent = device.VBUS || 'NA';
    document.getElementById('stat-Current').textContent = device.CUR || 'NA';
    document.getElementById('stat-Speed').textContent = device.SPD || 'NA';
    document.getElementById('stat-Rpm').textContent = device.RPM || 'NA';
    document.getElementById('stat-Position').textContent = device.POS || 'NA';
    document.getElementById('stat-Floor').textContent = device.CFL || 'NA';
    
  } catch (e) {
    console.error('Error loading device and telemetry:', e);
  }
}

// --- Function to fetch and render user information ---
async function fetchAndRenderUser(tb_device_id) {
  try {
    const res = await fetch(`/api/device-user/${tb_device_id}`);
    if (!res.ok) throw new Error('No user assigned');
    const user = await res.json();
    
    document.getElementById('deviceUser').textContent = user.address || 'NA';
    const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
    document.getElementById('deviceUserName').textContent = fullName || 'NA';
    const contactInfo = user.phone || user.email || 'NA';
    document.getElementById('deviceUserContact').textContent = contactInfo;
    
  } catch (e) {
    console.error('Error loading user info:', e.message);
    document.getElementById('deviceUser').textContent = 'NA';
    document.getElementById('deviceUserName').textContent = 'NA';
    document.getElementById('deviceUserContact').textContent = 'NA';
  }
}



// --- Page load and auto-sync setup ---
window.addEventListener('DOMContentLoaded', async function() {
  if (!deviceId) return;
  
  // Initial load
  await loadDeviceAndTelemetry(deviceId);
  await fetchAndRenderUser(deviceId);
  
  // Set up auto-sync every minute
  setInterval(async () => {
    try {
      console.log('🔄 Auto-refreshing device data...');
      await loadDeviceAndTelemetry(deviceId);
      await fetchAndRenderUser(deviceId);
      console.log('✅ Auto-refresh completed successfully');
    } catch (e) {
      console.error('❌ Error in auto-sync:', e.message);
    }
  }, 60000); // 60000ms = 1 minute
});

// --- Drag-and-drop functionality for stats grid ---
window.addEventListener('DOMContentLoaded', () => {
  const grid = document.querySelector('.stats-grid');
  if (!grid) return;
  
  // Assign a unique data-key to each stat-item based on its stat-value id
  grid.querySelectorAll('.stat-item').forEach(item => {
    const statValue = item.querySelector('.stat-value');
    if (statValue && statValue.id) {
      item.setAttribute('data-key', statValue.id);
    }
  });
  
  // Restore order from localStorage
  const savedOrder = JSON.parse(localStorage.getItem('telemetryStatOrder') || '[]');
  if (savedOrder.length) {
    const items = Array.from(grid.children);
    savedOrder.forEach(key => {
      const item = items.find(i => i.getAttribute('data-key') === key);
      if (item) grid.appendChild(item);
    });
  }
  
  // Enable drag-and-drop
  Sortable.create(grid, {
    animation: 150,
    onEnd: function () {
      const ids = Array.from(grid.children).map(card => card.getAttribute('data-key'));
      localStorage.setItem('telemetryStatOrder', JSON.stringify(ids));
    }
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="js/auth.js"></script>
<script src="js/script.js"></script>
</body>
</html>
