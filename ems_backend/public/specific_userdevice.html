    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Specific User Device | EMS</title>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/stats.css" />
    </head>
    <body class="dashboard-body">
    <header class="topbar">
      <div class="topbar-logo-title" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
        <img src="assets/adlex_logo.png" alt="ADLEX Logo" class="topbar-logo">
        <h2 class="topbar-title" style="margin:0;flex:1;text-align:center;">Elevator Data</h2>
        <span class="user-role-container">
        <span class="user-icon">üë§</span>
        <span class="userRoleDisplay" id="userRoleDisplay"></span>
      </span>
      </div>
      <button id="darkModeToggle" style="margin-left:20px;">üåô</button>
    </header>

    <!-- Sidebar for normal users/admins -->
    <aside class="sidebar" id="sidebar-normal" style="display:none;">
      <ul>
      <li class="nav-link active" onclick="navigate('users.html')">Location</li>
      <li class="nav-link" onclick="navigate('supervisors.html')">User</li>
      <li class="nav-link" onclick="navigate('devices.html')">Devices</li>
      <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
      <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
      
      </ul>
      <div class="logout-link" onclick="logout()">Logout</div>
      <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
  </aside>
  
  <!-- Sidebar for supervisors (read-only) -->
  <aside class="sidebar" id="sidebar-supervisor" style="display:none;">
      <ul>
      <li class="nav-link active" onclick="navi('super_device_overview.html')">My Devices</li>
      <li class="nav-link" onclick="navigate('logs.html')">Logs</li>
      <li class="nav-link" onclick="navigate('support.html')">Support Center</li>
      </ul>
      <div class="logout-link" onclick="logout()">Logout</div>
      <button class="sidebar-arrow" id="sidebarArrow" aria-label="Hide menu">&#8592;</button>
  </aside>
    <button class="sidebar-hamburger" id="sidebarHamburger" aria-label="Show menu">&#9776;</button>
    <div class="main-content">
        <!-- Device Info Bar -->
        <div id="deviceInfoBar" class="deviceInfoBar">
        <span>Status: <span id="deviceStatus">-</span></span>
        <span>Last Upload: <span id="deviceLastUpload">-</span></span>
      </div>
      <section class="device-detail-section">
        <div class="device-card" id="deviceCard">
          <!-- <div class="device-card-header">
            <div class="device-id" id="deviceId" style="font-size:1.5em;font-weight:bold;">-</div>
          </div> -->
          <div class="device-card-body">
            <div class="device-field">Location Name<br><span id="deviceUser">-</span></div>
            <div class="device-field">MAC Address<br><span id="deviceMac">-</span></div>
            <div class="device-field">Device ID<br><span id="deviceIdValue">-</span></div>
            <div class="device-field">Serial Number<br><span id="deviceSerial">-</span></div>
            <div class="device-field">City<br><span id="deviceLocation">-</span></div>
          </div>
          <div class="device-user-info">
            <div class="user-info-field">User Name<br><span id="deviceUserName">-</span></div>
            <div class="user-info-field">Contact Info<br><span id="deviceUserContact">-</span></div>
          </div>
        </div>
        <div class="device-tabs">
          <button class="device-tab active" id="tabStats">Position Data</button>
          <button class="device-tab" id="tabAlarms">Alarms</button>
          <button class="device-tab" id="tabMode">Control Data</button> 
        </div>
      </section>
      <!-- <div class="device-map">
        <iframe src="https://maps.google.com/maps?q=Samsan%20Technische%20Labs%20Pvt%20Ltd%20(Kothrud)&t=&z=15&ie=UTF8&iwloc=&output=embed"></iframe>
      </div> -->
      <div id="map" style="width:100%; height:250px; margin-top:20px;"></div>
      <div class="stats-grid">
        <div class="stat-item"><div class="stat-icon">üîÅ</div><div class="stat-label">Direction Count</div><div class="stat-value" id="stat-DirCount">-</div></div>
        <div class="stat-item"><div class="stat-icon">üîÅ</div><div class="stat-label">Direction Change Count</div><div class="stat-value" id="stat-DirChangeCount">-</div></div>
        <div class="stat-item"><div class="stat-icon">üìè</div><div class="stat-label">Total Work Count</div><div class="stat-value" id="stat-TotalWorkCount">-</div></div>
        <!-- <div class="stat-item"><div class="stat-icon">üìè</div><div class="stat-label">Total Direction Travelled</div><div class="stat-value" id="stat-TotalDistanceTravelled">-</div></div> -->
        <div class="stat-item"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-label">Total Time Work</div><div class="stat-value" id="stat-TotalWorkTime">-</div></div>
        <div class="stat-item"><div class="stat-icon">üö¶</div><div class="stat-label">Total Travel Time</div><div class="stat-value" id="stat-TotalTravelTime">-</div></div>
        <div class="stat-item"><div class="stat-icon">üö¶</div><div class="stat-label">Total Road Time</div><div class="stat-value" id="stat-TotalRoadTime">-</div></div>
        <div class="stat-item"><div class="stat-icon">üõë</div><div class="stat-label">Total Stop Count</div><div class="stat-value" id="stat-TotalStopCount">-</div></div>
        <div class="stat-item"><div class="stat-icon">üö™</div><div class="stat-label">Door A Status</div><div class="stat-value" id="stat-DoorAStatus">-</div></div>
        <div class="stat-item"><div class="stat-icon">üö™</div><div class="stat-label">Door B Status</div><div class="stat-value" id="stat-DoorBStatus">-</div></div>
        <!-- <div class="stat-item"><div class="stat-icon">üìÖ</div><div class="stat-label">Last Signal Date</div><div class="stat-value" id="stat-LastSignalDate">-</div></div> -->
        <div class="stat-item"><div class="stat-icon">‚ö°</div><div class="stat-label">Emergency Alarm</div><div class="stat-value" id="stat-EmergencyAlarm">-</div></div>
      </div>
    </div>
    
    <script>
    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get('deviceId');
    const username = sessionStorage.getItem('selectedUsername') || 'NA';
    document.getElementById('deviceUser').textContent = username;
    
    async function renderMapFromTelemetry(telemetry) {
      // Convert coordinates safely
      const lat = parseFloat(telemetry.LAT );
      const lng = parseFloat(telemetry.LNG );
    
      const mapContainer = document.getElementById('map');
    
      if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
        mapContainer.innerHTML = 'Location not available';
        return;
      }
    
      // Clear any previous message
      mapContainer.innerHTML = ''; // ensures map renders again if needed
    
      // Await in case you want to prepare or load something else in future
      await new Promise(resolve => setTimeout(resolve, 0)); // placeholder await
    
      const map = new google.maps.Map(mapContainer, {
        center: { lat, lng },
        zoom: 15
      });
    
      new google.maps.Marker({
        position: { lat, lng },
        map: map,
        title: 'Device Location'
      });
    }
    
    // Use this in your page load and sync button
async function syncAndRenderTelemetry() {
  if (!deviceId) return;
  try {
    const res = await fetch(`/api/device/${deviceId}/sync-telemetry`, { method: 'POST' });
    if (!res.ok) throw new Error('Failed to sync telemetry');
    const telemetry = await res.json();
    renderTelemetryToUI(telemetry);
    await fetchAndRenderUser(telemetry.tb_device_id); // ‚Üê call this
  } catch (e) {
    console.error('Error syncing telemetry:', e);
    alert('Error syncing telemetry: ' + e.message);
  }
}
async function fetchAndRenderUser(tb_device_id) {
  try {
    const res = await fetch(`/api/device-user/${tb_device_id}`);
    if (!res.ok) throw new Error('No user assigned');
    const user = await res.json();
    
    // Update location name (existing field)
    document.getElementById('deviceUser').textContent = user.address || 'NA';
    
    // Update user name field (new field)
    const fullName = `${user.first_name || ''} ${user.last_name || 'null'}`.trim();
    document.getElementById('deviceUserName').textContent = fullName || 'NA';
    
    // Update contact info field (new field) - show phone or email
    const contactInfo = user.phone || user.email || 'NA';
    document.getElementById('deviceUserContact').textContent = contactInfo;
    
  } catch (e) {
    console.error('Error loading user info:', e.message);
    document.getElementById('deviceUser').textContent = 'NA';
    document.getElementById('deviceUserName').textContent = 'NA';
    document.getElementById('deviceUserContact').textContent = 'NA';
  }
}

    document.getElementById('tabStats').onclick=function(){};
    document.getElementById('tabAlarms').onclick=function(){if(deviceId) window.location.href=`elevatorerror.html?deviceId=${deviceId}`;};
    document.getElementById('tabMode').onclick=function(){if(deviceId) window.location.href=`totaldevicestats.html?deviceId=${deviceId}`;};
    function navigate(page){window.location.href=page;}

    // Telemetry keys to display (should match backend)
    const telemetryKeys = [
    'MacAddress','Location','LastSignalDate','SerialNum','DeviceName','DeviceId',
    'ERR', 'CFL', 'POS', 'SPD', 'RPM', 'VBUS', 'CUR', 'ID', 'CSQ', 'LAT', 'LNG',
    'TWTIME', 'TWCOUNT', 'DIRCHG', 'DIRCNT', 'TRVTIME', 'DOORA', 'DOORB', 'RDTIME', 'STPCNT'
  ];
    
    document.getElementById("deviceUser").textContent = username || 'NA';
    
    // Global variable to store device active status
    let deviceActiveStatus = 'NA';

    // Function to fetch and set device active status
    async function fetchAndSetDeviceActiveStatus(deviceId) {
      try {
        const deviceInfoRes = await fetch(`https://thingsboard.cloud/api/deviceInfos/${deviceId}`);
        if (deviceInfoRes.ok) {
          const deviceInfo = await deviceInfoRes.json();
          const isActive = deviceInfo.active;
          deviceActiveStatus = isActive ? 'Active' : 'Inactive';
        } else {
          deviceActiveStatus = 'NA';
        }
      } catch (e) {
        deviceActiveStatus = 'NA';
      }
      document.getElementById('deviceStatus').textContent = deviceActiveStatus;
    }

    // Call this once on page load and whenever deviceId changes
    window.addEventListener('DOMContentLoaded', function() {
      if (deviceId) fetchAndSetDeviceActiveStatus(deviceId);
    });
    
    // Handle Sync button click
    // Render telemetry data into device card and stats cards
    async function renderTelemetryToUI(telemetry) {
      try {
        // Device Card
        //document.getElementById('deviceUser').textContent = telemetry.username || 'NA'; 
        //document.getElementById('deviceName').textContent = telemetry.DeviceName || 'NA';
        document.getElementById('deviceIdValue').textContent = telemetry.ID || telemetry.DeviceId || 'NA';
        document.getElementById('deviceMac').textContent = telemetry.MacAddress || 'NA';
        document.getElementById('deviceSerial').textContent = telemetry.SerialNum || 'NA';
        document.getElementById('deviceLocation').textContent = telemetry.Location || 'NA';
        // Status is now set globally
        document.getElementById('deviceStatus').textContent = deviceActiveStatus;
        // Show only time for log_time
        if (telemetry.log_time) {
          const t = new Date(telemetry.log_time);
          const timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          document.getElementById('deviceLastUpload').textContent = timeStr;
        } else {
          document.getElementById('deviceLastUpload').textContent = 'NA';
        }
        // Stats cards
        document.getElementById('stat-DirCount').textContent = telemetry.DIRCNT || 'NA';
        //document.getElementById('stat-TotalDistanceTravelled').textContent = telemetry.TotalDistanceTravelled || 'NA';
        document.getElementById('stat-DirChangeCount').textContent = telemetry.DIRCHG || 'NA';
        document.getElementById('stat-TotalWorkCount').textContent = telemetry.TWCOUNT || 'NA';
        document.getElementById('stat-TotalRoadTime').textContent = telemetry.RDTIME || 'NA';
        document.getElementById('stat-TotalWorkTime').textContent = telemetry.TWTIME || 'NA';
        document.getElementById('stat-TotalTravelTime').textContent = telemetry.TRVTIME || 'NA';
        document.getElementById('stat-TotalStopCount').textContent = telemetry.STPCNT || 'NA';
        document.getElementById('stat-DoorAStatus').textContent = telemetry.DOORA || 'NA';
        document.getElementById('stat-DoorBStatus').textContent = telemetry.DOORB || 'NA';
        //document.getElementById('stat-LastSignalDate').textContent = telemetry.LastSignalDate || 'NA';
        document.getElementById('stat-EmergencyAlarm').textContent = telemetry.ERR || 'NA';
        //document.getElementById('stat-Speed').textContent = telemetry.SPD || 'NA';
        //document.getElementById('stat-Rpm').textContent = telemetry.RPM || 'NA';
        //document.getElementById('stat-Position').textContent = telemetry.POS || 'NA';
      } catch (err) {
        console.error('Error rendering telemetry:', err);
        alert('Could not update UI with telemetry data.');
      }
    }
    

    // When telemetry is fetched or synced, call this function
    // Example usage after sync:
    // renderTelemetryToUI(telemetry);

    // Update auto-sync to fetch both telemetry and active status every minute
async function autoSyncTelemetryAndStatus() {
  if (!deviceId) return;
  
  // Fetch and render telemetry first
  try {
    const res = await fetch(`/api/device/${deviceId}/sync-telemetry`, { method: 'POST', headers: { 'x-user-role': 'admin' } });
    if (!res.ok) throw new Error('Failed to sync telemetry');
    const telemetry = await res.json();
    renderTelemetryToUI(telemetry);
    
    // Use tb_device_id from telemetry for status check
    const tbDeviceId = telemetry.tb_device_id || deviceId;
    console.log(`[DEBUG] Auto-sync using tb_device_id: ${tbDeviceId} for status check`);
    
    // Fetch and set active status using correct tb_device_id
    await fetchAndSetDeviceActiveStatus(tbDeviceId);
    // Fetch and render user information
    await fetchAndRenderUser(tbDeviceId);
  } catch (e) {
    console.error('Error auto-syncing telemetry:', e.message);
  }
}
// Start auto-sync on page load and every minute
window.addEventListener('DOMContentLoaded', async function() {
  let tbDeviceId = deviceId; // Default to deviceId if we can't get tb_device_id
  
  // Try to get the correct tb_device_id from device details
  if (deviceId) {
    try {
      const res = await fetch(`/api/device-details/${deviceId}`);
      if (res.ok) {
        const device = await res.json();
        tbDeviceId = device.tb_device_id || deviceId;
        console.log(`[DEBUG] Using tb_device_id: ${tbDeviceId} for status check`);
      }
    } catch (e) {
      console.error('[DEBUG] Could not fetch device details:', e);
    }
    
    // Fetch status using the correct tb_device_id
    await fetchAndSetDeviceActiveStatus(tbDeviceId);
    // Fetch user info
    await fetchAndRenderUser(tbDeviceId);
  }
  
  autoSyncTelemetryAndStatus();
  setInterval(autoSyncTelemetryAndStatus, 60000); // 60,000 ms = 1 minute
});

    function navi(url) {
      const role = localStorage.getItem('userRole');
      const username = localStorage.getItem('username'); // this is supervisor_id
    
      // Only attach supervisor_id if role is supervisor
      if (role === 'supervisor' && url.includes('super_device_overview.html')) {
        if (username) {
          url += `?supervisor_id=${username}`;
        } else {
          alert('Supervisor session expired. Please log in again.');
          window.location.href = 'login.html';
          return;
        }
      }
    
      // Redirect using final URL
      window.location.href = url;
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      const grid = document.querySelector('.stats-grid');
      if (!grid) return;
      // Assign a unique data-key to each stat-item based on its stat-value id
      grid.querySelectorAll('.stat-item').forEach(item => {
        const statValue = item.querySelector('.stat-value');
        if (statValue && statValue.id) {
          item.setAttribute('data-key', statValue.id);
        }
      });
      // Restore order from localStorage
      const savedOrder = JSON.parse(localStorage.getItem('telemetryStatOrder') || '[]');
      if (savedOrder.length) {
        const items = Array.from(grid.children);
        savedOrder.forEach(key => {
          const item = items.find(i => i.getAttribute('data-key') === key);
          if (item) grid.appendChild(item);
        });
      }
      // Enable drag-and-drop
      Sortable.create(grid, {
        animation: 150,
        onEnd: function () {
          const ids = Array.from(grid.children).map(card => card.getAttribute('data-key'));
          localStorage.setItem('telemetryStatOrder', JSON.stringify(ids));
        }
      });
    });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEkRLsky3llbZBK44ifns1l84_Wbtz8v4"></script>
    <script src="js/script.js"></script>
    <!-- Add SortableJS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    </body>
    </html>
